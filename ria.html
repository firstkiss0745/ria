<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© RIA Group</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">


    <style>
        .btn-primary {
            background: #2563eb;
            color: #fff;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: #6b7280;
            color: #fff;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: #22c55e;
            color: #fff;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .card {
            background: #fff;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-600 to-indigo-900 min-h-screen overflow-x-hidden">
    <div class="flex min-h-screen w-full">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-72 bg-white shadow-xl rounded-xl border border-gray-200 p-6 min-h-screen flex flex-col justify-between hidden">
            <div>
                <div class="text-center py-4 mb-6">
                    <img src="https://i.postimg.cc/yJHTv3zM/logo.png" alt="RIA Group Logo"
                        class="w-16 h-16 mx-auto mb-2 rounded-xl shadow" />
                    <div class="text-gray-900 font-bold text-lg tracking-wide">RIA Group</div>
                </div>
                <nav class="flex flex-col gap-2">
                    <div>
                        <a href="#" onclick="showPage('dashboard')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üè†</span>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('addPaperType')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üîº</span>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('usage')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üí∏</span>
                            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('addUser')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">‚ûï</span>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('approval')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üõÇ</span>
                            <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('report')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üìä</span>
                            <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('manageStock')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üì¶</span>
                            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                        </a>
                    </div>
                    <div>
                        <a href="#" onclick="showPage('news')"
                            class="nav-item flex items-center gap-3 p-3 rounded-xl text-gray-900 font-semibold hover:bg-gray-100 transition-all duration-150">
                            <span class="text-2xl">üì¢</span>
                            <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
                        </a>
                    </div>
                </nav>

            </div>
            <div class="bg-gray-50 p-4 rounded-lg text-sm text-gray-900 mt-10">
                <div>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <span id="currentUser">-</span></div>
                <div>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: <span id="currentRole">-</span></div>
                <button onclick="logout()"
                    class="mt-3 w-full text-xs bg-red-500 px-3 py-2 rounded font-bold text-white hover:bg-red-600 transition-all">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </aside>


        <!-- Main Content -->

        <main id="mainContent" class="flex-1 p-6 md:p-10 overflow-y-auto max-w-full overflow-x-auto">
            <!-- News Page -->
            <div id="newsPage" class="hidden">
                <div class="card p-8 rounded-xl shadow-lg max-w-2xl mx-auto my-8">
                    <h2 class="text-xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2>
                    <form onsubmit="submitNewsForm(event)">
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß</label>
                            <input type="text" id="newsTitle" class="w-full border rounded p-2" required>
                        </div>
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
                            <textarea id="newsContent" class="w-full border rounded p-2" required></textarea>
                        </div>
                        <button type="submit" class="btn-primary px-4 py-2 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß</button>
                    </form>
                    <hr class="my-6">
                    <h3 class="text-lg font-bold mb-2">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <div id="newsList"></div>
                </div>
            </div>

            <!-- Manage Stock Page -->
            <div id="manageStockPage" class="hidden">
                <div class="card p-8 rounded-xl shadow-lg max-w-2xl mx-auto my-8">
                    <h2 class="text-xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                    <form onsubmit="addPaperStock(event)">
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                            <select id="stockPaperType" class="w-full border rounded p-2" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° (+ ‡∏´‡∏£‡∏∑‡∏≠ - ‡πÑ‡∏î‡πâ)</label>
                            <input type="number" id="stockChangeAmount" class="w-full border rounded p-2" required>
                        </div>
                        <button type="submit" class="btn-success px-4 py-2 rounded">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</button>
                    </form>
                    <hr class="my-6">
                    <h3 class="text-lg font-bold mb-2">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                    <div id="currentStockList"></div>
                </div>
            </div>

            <!-- Login Page -->
            <div id="loginPage" class="max-w-md mx-auto mt-20">
                <div class="card rounded-2xl shadow-2xl p-8">
                    <div class="text-center mb-6">
                        <img src="https://i.postimg.cc/yJHTv3zM/logo.png" alt="RIA Group Logo"
                            class="w-20 h-20 mx-auto mb-4 rounded-xl">
                        <h2 class="text-2xl font-bold text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                        <p class="text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</p>
                    </div>
                    <form onsubmit="login(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <input type="text" id="loginUsername"
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input type="password" id="loginPassword"
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                required>
                        </div>
                        <button type="submit"
                            class="btn-primary w-full text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-all">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </form>
                    <div class="mt-4 text-sm text-gray-600">
                        <p>‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ADMIN</p>
                    </div>
                </div>
            </div>
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="hidden">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-white mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ RIA Group
                    </h1>
                    <p class="text-blue-100">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="bg-blue-500 p-3 rounded-full mr-4">
                                <span class="text-white text-xl">üìÑ</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                                <p class="text-2xl font-bold text-blue-600" id="todayUsage">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="bg-green-500 p-3 rounded-full mr-4">
                                <span class="text-white text-xl">üì¶</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                                <p class="text-2xl font-bold text-green-600" id="remainingPaper">1000</p>
                                <div id="manageStockList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="bg-orange-500 p-3 rounded-full mr-4">
                                <span class="text-white text-xl">‚è≥</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                                <p class="text-2xl font-bold text-orange-600" id="pendingRequests">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
                        <canvas id="paperTypeChart" class="h-56" style="max-height:300px;"></canvas>
                    </div>
                    <div class="card rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h3>
                        <div id="dashboardNews"></div>
                        <div class="space-y-3">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Paper Type Page -->
            <div id="addPaperTypePage" class="hidden">
                <div class="card p-8 rounded-xl shadow-lg max-w-lg mx-auto my-8">
                    <h2 class="text-xl font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</h2>
                    <form onsubmit="addPaperType(event)">
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                            <input type="text" id="paperTypeName" class="w-full border rounded p-2" required>
                        </div>
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea id="paperTypeDescription" class="w-full border rounded p-2"></textarea>
                        </div>
                        <button type="submit" class="btn-primary px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </form>
                    <hr class="my-6">
                    <h3 class="text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</h3>
                    <div id="currentPaperTypes"></div>
                </div>
            </div>
            <!-- Usage Page -->
            <div id="usagePage" class="hidden">
                <div class="card p-8 rounded-xl shadow-lg max-w-lg mx-auto my-8">
                    <h2 class="text-xl font-bold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</h2>
                    <form onsubmit="submitUsageRequest(event)">
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label>
                            <input type="text" id="requestUserName" class="w-full border rounded p-2" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                            <input type="text" id="requestDepartment" class="w-full border rounded p-2" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                            <select id="requestPaperType" class="w-full border rounded p-2" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏£‡∏µ‡∏°/‡∏ä‡∏∏‡∏î)</label>
                            <input type="number" id="requestQuantity" class="w-full border rounded p-2" min="1"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="block font-semibold mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <textarea id="requestNote" class="w-full border rounded p-2"></textarea>
                        </div>
                        <button type="submit" class="btn-success px-4 py-2 rounded">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</button>
                    </form>
                </div>
            </div>
            <!-- Add User Page -->
            <div id="addUserPage" class="card p-8 rounded-xl shadow-lg max-w-lg mx-auto my-8 bg-white hidden">
                <h2 class="text-xl font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                <form onsubmit="addUser(event)">
                    <div class="mb-3">
                        <label class="block font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="userName"
                            class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="block font-semibold mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input type="text" id="userDepartment"
                            class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="block font-semibold mb-1">Username</label>
                        <input type="text" id="userUsername"
                            class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="block font-semibold mb-1">Password</label>
                        <input type="password" id="userPassword"
                            class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                            required>
                    </div>
                    <div class="mb-6">
                        <label class="block font-semibold mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
                        <select id="userRole"
                            class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                            required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</option>
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-indigo-700 transition-all">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    </button>
                </form>
            </div>


            <!-- Approval Page -->
            <div id="approvalPage" class="hidden">
                <div class="card p-8 rounded-xl shadow-lg max-w-2xl mx-auto my-8">
                    <h2 class="text-xl font-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h2>
                    <div id="pendingRequestsList"></div>
                    <hr class="my-6">
                    <h3 class="text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h3>
                    <div id="approvedRequestsList"></div>
                </div>
            </div>
            <!-- Report Page -->
            <div id="reportPage" class="hidden">
                <div class="card p-8 rounded-xl shadow-lg max-w-4xl mx-auto my-8">
                    <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</h2>
                    <div class="mb-4">
                        <select id="statusFilter" class="border rounded p-2" onchange="loadReportData()">
                            <option value="All">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="Approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                            <option value="Pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                            <option value="Rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                        </select>
                    </div>
                    <div id="reportData"></div>
                    <div class="my-8">
                        <canvas id="reportChart" class="h-56" style="max-height:300px;"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let users = [];
        let paperTypes = [];
        let usageRequests = [];

        // Google Sheets Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgAcZ4Q4tDrXOP82C_twnhp1veUUUptt5E7NnfReo35fS8Bzlc0lMD9YRLe2_RrtzS/exec';

        // Google Sheets Structure:
        // Sheet 1: "Users" - columns: ID, Name, Department, Role, CreatedAt
        // Sheet 2: "PaperTypes" - columns: ID, Name, Description, CreatedAt
        // Sheet 3: "UsageRequests" - columns: ID, UserID, UserName, Department, PaperTypeID, PaperTypeName, Quantity, Note, Status, RequestDate, RequestedBy, ApprovedBy, ApprovedDate, RejectedBy, RejectedDate, RejectionReason, WithdrawnStatus, WithdrawnDate, WithdrawnBy

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å cache ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡πá‡∏ß)
            if (localStorage.getItem('users')) users = JSON.parse(localStorage.getItem('users'));
            if (localStorage.getItem('paperTypes')) paperTypes = JSON.parse(localStorage.getItem('paperTypes'));
            if (localStorage.getItem('usageRequests')) usageRequests = JSON.parse(localStorage.getItem('usageRequests'));

            checkLoginStatus();    // ‚úÖ render dashboard/sidebar ‡∏à‡∏≤‡∏Å localStorage ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

            updateDashboard();     // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å cache

            // fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î async ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï cache/UI ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
            loadUsersFromSheet(() => {
                checkLoginStatus(); // ‡∏ñ‡πâ‡∏≤ users ‡∏™‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ
            });
            loadPaperTypesFromSheet(updateDashboard);
            loadUsageRequestsFromSheet(updateDashboard);
        });




        // Authentication functions
        // 1. login event (‡πÉ‡∏ô <form onsubmit="login(event)">)
        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            await checkLogin(username, password); // <-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö async!
        }

        // 2. checkLogin ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        async function checkLogin(username, password) {
            const passwordHash = await hashPassword(password);
            const found = users.find(u => u.username === username && u.passwordHash === passwordHash);
            if (found) {
                currentUser = found.username;
                currentRole = found.role;
                localStorage.setItem('currentUser', currentUser);
                localStorage.setItem('currentRole', currentRole);
                updateUserDisplay();
                showMainApp();
                showPage('dashboard');
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser}`,
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î'
                });
            }
        }


        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentRole');
            currentUser = null;
            currentRole = null;

            // ‡∏ã‡πà‡∏≠‡∏ô sidebar ‡∏î‡πâ‡∏ß‡∏¢ id="sidebar"
            document.getElementById('sidebar').classList.add('hidden');

            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ loginPage
            document.getElementById('loginPage').classList.remove('hidden');
            document.querySelectorAll('[id$="Page"]').forEach(page => {
                if (page.id !== 'loginPage') page.classList.add('hidden');
            });
        }




        function checkLoginStatus() {
            currentUser = localStorage.getItem('currentUser');
            currentRole = localStorage.getItem('currentRole');
            // ‡πÉ‡∏ä‡πâ users ‡∏à‡∏≤‡∏Å cache ‡∏Å‡πà‡∏≠‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏≠ users ‡∏™‡∏î‡∏à‡∏≤‡∏Å google sheet)
            if (currentUser && currentRole && users.some(u => u.username === currentUser && u.role === currentRole)) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboardPage').classList.remove('hidden');
                updateUserDisplay();
            } else {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentRole');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
            }
        }





        function updateUserDisplay() {
            document.getElementById('currentUser').textContent = currentUser || '-';
            document.getElementById('currentRole').textContent = currentRole || '-';

            // Show/hide menus based on role
            if (currentRole === 'Admin') {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.parentElement.classList.remove('hidden');
                });
            } else {
                // User can only see Dashboard and Usage Page
                const allowedMenus = ['dashboard', 'usage'];
                document.querySelectorAll('.nav-item').forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick) {
                        const pageId = onclick.match(/showPage\('(.+?)'\)/);
                        if (pageId && !allowedMenus.includes(pageId[1])) {
                            item.parentElement.classList.add('hidden');
                        } else {
                            item.parentElement.classList.remove('hidden');
                        }
                    }
                });
            }
        }


        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
        }

        // Navigation functions
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('[id$="Page"]').forEach(page => {
                page.classList.add('hidden');
            });

            // Show selected page
            document.getElementById(pageId + 'Page').classList.remove('hidden');

            // Load page-specific data
            switch (pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'addPaperType':
                    loadPaperTypesFromSheet(loadCurrentPaperTypes);
                    loadCurrentStock();
                    break;

                case 'usage':
                    loadUsersForDropdown();
                    loadPaperTypesForDropdown();
                    autofillUserInfo();
                    break;
                case 'addUser':
                    loadUsersFromSheet();
                    break;
                case 'approval':
                    if (currentRole !== 'Admin') {
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á',
                            text: '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ'
                        });
                        showPage('dashboard');
                        return;
                    }
                    loadUsageRequestsFromSheet(function () {
                        loadPendingRequests();
                        loadApprovedRequests();
                    });
                    break;
                case 'report':
                    if (currentRole !== 'Admin') {
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á',
                            text: '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ'
                        });
                        showPage('dashboard');
                        return;
                    }
                    loadUsageRequestsFromSheet(function () {
                        loadReportData();
                    });
                    break;
                case 'manageStock':
                    loadPaperTypesFromSheet(function () {
                        renderStockDropdown();
                        loadCurrentStock();
                    });
                    break;
                case 'news':
                    loadNews(); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                    break;

            }
        }


        // Data management functions
        function initializeDefaultData() {
            if (!localStorage.getItem('users')) {
                users = [
                    { id: 1, name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', department: 'IT', role: 'Admin' },
                    { id: 2, name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô', department: 'HR', role: 'User' },
                    { id: 3, name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏Ç‡∏¢‡∏±‡∏ô', department: 'Finance', role: 'User' }
                ];
                saveToLocalStorage();
            }

            if (!localStorage.getItem('paperTypes')) {
                paperTypes = [
                    { id: 1, name: 'A4 80g', description: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 ‡∏Ç‡∏≤‡∏ß 80 ‡πÅ‡∏Å‡∏£‡∏°' },
                    { id: 2, name: 'A3 80g', description: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A3 ‡∏Ç‡∏≤‡∏ß 80 ‡πÅ‡∏Å‡∏£‡∏°' },
                    { id: 3, name: 'A4 ‡∏™‡∏µ', description: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 ‡∏™‡∏µ‡∏ï‡πà‡∏≤‡∏á‡πÜ' }
                ];
                saveToLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const savedUsers = localStorage.getItem('users');
            const savedPaperTypes = localStorage.getItem('paperTypes');
            const savedUsageRequests = localStorage.getItem('usageRequests');

            if (savedUsers) users = JSON.parse(savedUsers);
            if (savedPaperTypes) paperTypes = JSON.parse(savedPaperTypes);
            if (savedUsageRequests) usageRequests = JSON.parse(savedUsageRequests);
        }

        function saveToLocalStorage() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('paperTypes', JSON.stringify(paperTypes));
            localStorage.setItem('usageRequests', JSON.stringify(usageRequests));
        }

        // Google Sheets integration
        function sendToGoogleSheet(data, callback) {
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Create JSONP callback
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function (response) {
                delete window[callbackName];
                document.body.removeChild(script);

                Swal.close();
                if (callback) callback(response);
            };

            // Create script element for JSONP
            const script = document.createElement('script');
            const params = new URLSearchParams(data);
            params.append('callback', callbackName);
            script.src = GOOGLE_SCRIPT_URL + '?' + params.toString();

            script.onerror = function () {
                delete window[callbackName];
                document.body.removeChild(script);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ'
                });
            };

            document.body.appendChild(script);
        }

        function loadFromGoogleSheet(sheetName, callback) {
            // Swal.fire({
            //     title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
            //     text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
            //     allowOutsideClick: false,
            //     didOpen: () => {
            //         Swal.showLoading();
            //     }
            // });

            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function (response) {
                delete window[callbackName];
                document.body.removeChild(script);

                Swal.close();
                if (callback) callback(response);
            };

            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=read&sheet=' + sheetName + '&callback=' + callbackName;

            script.onerror = function () {
                delete window[callbackName];
                document.body.removeChild(script);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ'
                });
            };

            document.body.appendChild(script);
        }

        // Paper Type functions
        function addPaperType(event) {
            event.preventDefault();

            const name = document.getElementById('paperTypeName').value.trim();
            const description = document.getElementById('paperTypeDescription').value.trim();

            if (!name) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©'
                });
                return;
            }

            // Check if paper type already exists
            const existingType = paperTypes.find(type => type.name.toLowerCase() === name.toLowerCase());
            if (existingType) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ã‡πâ‡∏≥',
                    text: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'
                });
                return;
            }

            const newPaperType = {
                id: Date.now(),
                name: name,
                description: description,
                createdAt: new Date().toISOString()
            };

            // Save to local storage
            paperTypes.push(newPaperType);
            saveToLocalStorage();

            // Send to Google Sheets
            const data = {
                action: 'addPaperType',
                name: name,
                description: description,
                createdAt: newPaperType.createdAt
            };

            sendToGoogleSheet(data, function (response) {
                if (response && response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets ‡πÑ‡∏î‡πâ'
                    });
                }

                // Clear form and refresh display
                clearPaperTypeForm();
                loadCurrentPaperTypes();
            });
        }

        function clearPaperTypeForm() {
            document.getElementById('paperTypeName').value = '';
            document.getElementById('paperTypeDescription').value = '';
        }

        function loadCurrentPaperTypes() {
            const container = document.getElementById('currentPaperTypes');
            if (!container) return;

            container.innerHTML = '';

            if (paperTypes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
                return;
            }

            paperTypes.forEach(type => {
                const typeDiv = document.createElement('div');
                typeDiv.className = 'bg-blue-50 border border-blue-200 p-3 rounded-lg flex justify-between items-start';
                typeDiv.innerHTML = `
                <div class="flex-1">
                    <h4 class="font-semibold text-blue-800">${type.name}</h4>
                    <p class="text-sm text-blue-600 mt-1">${type.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}</p>
                    <p class="text-xs text-gray-500 mt-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(type.createdAt).toLocaleDateString('th-TH')}</p>
                </div>
                <div class="ml-4 space-x-2">
                    <button onclick="editPaperType(${type.id})" class="text-blue-600 hover:text-blue-800 text-sm">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="deletePaperType(${type.id})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
            `;
                container.appendChild(typeDiv);
            });
        }

        function editPaperType(typeId) {
            const type = paperTypes.find(t => t.id === typeId);
            if (!type) return;

            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©',
                html: `
            <input id="editPaperTypeName" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©" value="${type.name}">
            <textarea id="editPaperTypeDescription" class="swal2-textarea" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢">${type.description || ''}</textarea>
        `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    const name = document.getElementById('editPaperTypeName').value.trim();
                    const description = document.getElementById('editPaperTypeDescription').value.trim();
                    if (!name) {
                        Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©');
                        return false;
                    }
                    return { name, description };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï LocalStorage
                    type.name = result.value.name;
                    type.description = result.value.description;
                    saveToLocalStorage();
                    loadCurrentPaperTypes();

                    // ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets
                    sendToGoogleSheet({
                        action: 'updatePaperType',
                        id: type.id,
                        name: type.name,
                        description: type.description
                    }, function (response) {
                        if (response && response.success) {
                            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheet ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                            loadPaperTypesFromSheet();
                            Swal.fire({
                                icon: 'success',
                                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Google Sheets ‡πÑ‡∏î‡πâ'
                            });
                        }
                    });
                }
            });
        }


        function deletePaperType(typeId) {
            const type = paperTypes.find(t => t.id === typeId);
            if (!type) return;

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© "${type.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendToGoogleSheet({
                        action: 'deletePaperType',
                        id: typeId
                    }, function (response) {
                        if (response && response.success) {
                            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PaperTypes ‡∏à‡∏≤‡∏Å Google Sheets ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
                            loadPaperTypesFromSheet();
                            Swal.fire({
                                icon: 'success',
                                title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ'
                            });
                        }
                    });
                }
            });
        }


        function loadPaperTypesForStockDropdown() {
            const select = document.getElementById('stockPaperType');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© --</option>';
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ä‡πâ paperTypes ‡πÉ‡∏ô localStorage
            if (window.paperTypes && paperTypes.length > 0) {
                paperTypes.forEach(type => {
                    select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
                });
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets
                loadFromGoogleSheet('PaperTypes', function (res) {
                    if (res.success && res.data) {
                        res.data.forEach(type => {
                            select.innerHTML += `<option value="${type.ID || type.id}">${type.Name || type.name}</option>`;
                        });
                    }
                });
            }
        }





        // Usage functions
        function loadUsersForDropdown() {
            const select = document.getElementById('requestUser');
            if (!select) return;

            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</option>';

            console.log('Loading users:', users);

            users.filter(user => user.role === 'User').forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                option.setAttribute('data-department', user.department);
                select.appendChild(option);
            });

            // Add event listener for department auto-fill
            select.onchange = function () {
                const selectedOption = this.options[this.selectedIndex];
                const department = selectedOption.getAttribute('data-department') || '';
                const deptField = document.getElementById('requestDepartment');
                if (deptField) {
                    deptField.value = department;
                }
            };
        }

        // Paper withdrawal functions
        function withdrawPaper(requestId) {
            const request = usageRequests.find(req => req.id === requestId);
            if (!request || request.status !== 'Approved') {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ',
                    text: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                });
                return;
            }

            if (request.withdrawnStatus === 'Withdrawn') {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
                    text: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß'
                });
                return;
            }

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©',
                html: `
                <div class="text-left">
                    <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${request.userName}</p>
                    <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:</strong> ${request.paperTypeName}</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${request.quantity}</p>
                    <p class="text-red-600 mt-2">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</p>
                </div>
            `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#059669'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Update request status
                    request.withdrawnStatus = 'Withdrawn';
                    request.withdrawnDate = new Date().toISOString();
                    request.withdrawnBy = currentUser;

                    // Update paper stock (if tracking)
                    updatePaperStock(request.paperTypeId, -request.quantity);

                    saveToLocalStorage();

                    // Send to Google Sheets
                    const data = {
                        action: 'updateWithdrawal',
                        requestId: requestId,
                        withdrawnStatus: 'Withdrawn',
                        withdrawnDate: request.withdrawnDate,
                        withdrawnBy: currentUser
                    };

                    sendToGoogleSheet(data, function (response) {
                        Swal.fire({
                            icon: 'success',
                            title: '‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            html: `
                            <div class="text-left">
                                <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${request.userName}</p>
                                <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:</strong> ${request.paperTypeName}</p>
                                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${request.quantity}</p>
                                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${new Date().toLocaleDateString('th-TH')}</p>
                                <p class="text-green-600 mt-2">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            </div>
                        `,
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                        });

                        // Refresh current page data
                        if (document.getElementById('approvalPage').classList.contains('hidden') === false) {
                            loadApprovedRequests();
                        }
                        if (document.getElementById('reportPage').classList.contains('hidden') === false) {
                            loadReportData();
                        }
                        updateDashboard();
                    });
                }
            });
        }

        function updatePaperStock(paperTypeId, quantity) {
            // Initialize paper stock if not exists
            if (!localStorage.getItem('paperStock')) {
                const initialStock = {};
                paperTypes.forEach(type => {
                    initialStock[type.id] = 1000; // Default stock
                });
                localStorage.setItem('paperStock', JSON.stringify(initialStock));
            }

            const paperStock = JSON.parse(localStorage.getItem('paperStock'));
            if (paperStock[paperTypeId]) {
                paperStock[paperTypeId] += quantity;
                if (paperStock[paperTypeId] < 0) paperStock[paperTypeId] = 0;
            }
            localStorage.setItem('paperStock', JSON.stringify(paperStock));
        }

        function getPaperStock(paperTypeId) {
            const paperStock = JSON.parse(localStorage.getItem('paperStock') || '{}');
            return paperStock[paperTypeId] || 0;
        }

        function loadApprovedRequests() {
            const container = document.getElementById('approvedRequestsList');
            const approvedRequests = usageRequests.filter(req => req.status === 'Approved');

            container.innerHTML = '';

            if (approvedRequests.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>';
                return;
            }

            approvedRequests.forEach(request => {
                const isWithdrawn = request.withdrawnStatus === 'Withdrawn';
                const bgColor = isWithdrawn ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200';

                const requestDiv = document.createElement('div');
                requestDiv.className = `${bgColor} border p-4 rounded-lg`;
                requestDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${request.userName}</p>
                        <p><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> ${request.department}</p>
                        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:</strong> ${request.paperTypeName}</p>
                        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${request.quantity}</p>
                    </div>
                    <div>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠:</strong> ${new Date(request.requestDate).toLocaleDateString('th-TH')}</p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> ${new Date(request.approvedDate).toLocaleDateString('th-TH')}</p>
                        <p><strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${request.approvedBy}</p>
                        ${request.withdrawnDate ? `<p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${new Date(request.withdrawnDate).toLocaleDateString('th-TH')}</p>` : ''}
                    </div>
                    <div class="flex flex-col justify-center">
                        ${isWithdrawn ?
                        `<div class="text-center">
                                <span class="inline-block bg-green-500 text-white px-4 py-2 rounded-full text-sm font-semibold">
                                    ‚úÖ ‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                                </span>
                                <p class="text-xs text-gray-600 mt-1">‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏î‡∏¢: ${request.withdrawnBy}</p>
                            </div>` :
                        `<button onclick="withdrawPaper(${request.id})" class="btn-success text-white px-6 py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                üì¶ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
                            </button>`
                    }
                    </div>
                </div>
            `;
                container.appendChild(requestDiv);
            });
        }

        function loadPaperTypesForDropdown() {
            const select = document.getElementById('requestPaperType');
            if (!select) return;

            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</option>';

            console.log('Loading paper types:', paperTypes);

            paperTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        }
        function loadStockPaperDropdown() {
            const callback = 'cb_' + Math.random().toString(36).substring(2);
            window[callback] = function (res) {
                // DEBUG: ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô console
                console.log('API Response:', res);

                const select = document.getElementById('stockPaperType');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© --</option>';

                if (res.success && res.data) {
                    // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö header ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó
                    res.data.forEach(row => {
                        select.innerHTML += `<option value="${row.ID}">${row.Name}</option>`;
                    });
                }
                delete window[callback];
            };
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=read&sheet=PaperTypes&callback=' + callback;
            document.body.appendChild(script);
        }



        function submitUsageRequest(event) {
            event.preventDefault();
            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const userName = document.getElementById('requestUserName').value;
            const department = document.getElementById('requestDepartment').value;
            const paperTypeId = document.getElementById('requestPaperType').value;
            const quantity = document.getElementById('requestQuantity').value;
            const note = document.getElementById('requestNote').value;

            // ‡∏´‡∏≤ user object ‡∏à‡∏≤‡∏Å currentUser (login)
            const user = users.find(u => u.username === currentUser);

            if (!user) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà'
                });
                return;
            }
            if (!paperTypeId) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©',
                    text: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å'
                });
                return;
            }
            if (!quantity || quantity <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
                    text: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)'
                });
                return;
            }
            const paperType = paperTypes.find(p => String(p.id) === String(paperTypeId));
            if (!paperType) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏´‡∏°‡πà'
                });
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });

            const newRequest = {
                id: Date.now(),
                userId: user.id,
                userName: user.name,
                department: user.department,
                paperTypeId: paperType.id,
                paperTypeName: paperType.name,
                quantity: parseInt(quantity),
                note: note || '',
                status: 'Pending',
                requestDate: new Date().toISOString(),
                requestedBy: currentUser
            };

            // Save to localStorage
            usageRequests.push(newRequest);
            saveToLocalStorage();

            // Prepare data for Google Sheets
            const data = {
                action: 'addUsageRequest',
                userId: user.id,
                userName: user.name,
                department: user.department,
                paperTypeId: paperType.id,
                paperTypeName: paperType.name,
                quantity: quantity,
                note: note || '',
                status: 'Pending',
                requestDate: newRequest.requestDate,
                requestedBy: currentUser
            };

            sendToGoogleSheet(data, function (response) {
                if (response && response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        html: `<div class="text-left">
                        <p><strong>‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${user.name}</p>
                        <p><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> ${user.department}</p>
                        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:</strong> ${paperType.name}</p>
                        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${quantity}</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="text-yellow-600">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span></p>
                    </div>`,
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets ‡πÑ‡∏î‡πâ',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                }

                clearUsageForm();
            });
        }

        function clearUsageForm() {
            document.getElementById('requestUser').value = '';
            document.getElementById('requestDepartment').value = '';
            document.getElementById('requestPaperType').value = '';
            document.getElementById('requestQuantity').value = '';
            document.getElementById('requestNote').value = '';
        }

        function loadUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'bg-gray-50 p-3 rounded-lg flex justify-between items-center';
                userDiv.innerHTML = `
            <div>
                <p class="font-semibold">${user.name}</p>
                <p class="text-xs text-gray-400">username: <span class="font-mono">${user.username || '-'}</span></p>
                <p class="text-sm text-gray-600">${user.department} - ${user.role}</p>
            </div>
            <div class="space-x-2">
                <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
            </div>
        `;
                container.appendChild(userDiv);
            });
        }


        function loadUsersFromSheet(callback) {
            loadFromGoogleSheet('Users', function (response) {
                if (response && response.data) {
                    users = response.data.map(item => ({
                        id: item.ID,
                        name: item.Name,
                        department: item.Department,
                        role: item.Role,
                        username: item.Username || '',
                        passwordHash: item.Password || '',   // << Map ‡πÄ‡∏õ‡πá‡∏ô passwordHash !!
                        createdAt: item.CreatedAt,
                    }));
                    saveToLocalStorage();
                    if (callback) callback();
                    // ...loadUsersList(); // ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ callback ‡πÅ‡∏•‡πâ‡∏ß
                }
            });
        }






        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                html: `
      <input id="editName" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value="${user.name}">
      <input id="editDepartment" class="swal2-input" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å" value="${user.department}">
      <select id="editRole" class="swal2-input">
          <option value="User" ${user.role === 'User' ? 'selected' : ''}>User</option>
          <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
      </select>
    `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    const name = document.getElementById('editName').value;
                    const department = document.getElementById('editDepartment').value;
                    const role = document.getElementById('editRole').value;

                    if (!name || !department || !role) {
                        Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                        return false;
                    }
                    return { name, department, role };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï local
                    user.name = result.value.name;
                    user.department = result.value.department;
                    user.role = result.value.role;

                    saveToLocalStorage();
                    loadUsersList();

                    // === ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheet ===
                    sendToGoogleSheet({
                        action: 'updateUser',
                        id: user.id,
                        name: user.name,
                        department: user.department,
                        role: user.role
                    }, function (response) {
                        if (response && response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets ‡πÑ‡∏î‡πâ'
                            });
                        }
                    });
                }
            });
        }


        function deleteUser(userId) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡∏•‡∏ö‡∏ó‡∏µ‡πà Google Sheets ‡∏Å‡πà‡∏≠‡∏ô
                    sendToGoogleSheet({
                        action: 'deleteUser',
                        id: userId
                    }, function (response) {
                        if (response && response.success) {
                            // ‡πÇ‡∏´‡∏•‡∏î users ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Google Sheet
                            loadUsersFromSheet();
                            Swal.fire({
                                icon: 'success',
                                title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ'
                            });
                        }
                    });
                }
            });
        }



        // Approval functions
        function loadPendingRequests() {
            const container = document.getElementById('pendingRequestsList');

            // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
            console.log('== usageRequests ==', usageRequests);

            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (robust: ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ status ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á, ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà, null, undefined)
            const pendingRequests = usageRequests.filter(
                req => typeof req.status === 'string' && req.status.trim().toLowerCase() === 'pending'
            );

            // Debug: ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
            console.log('== pendingRequests ==', pendingRequests);

            container.innerHTML = '';
            if (pendingRequests.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>';
                return;
            }

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ request ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            pendingRequests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4';

                requestDiv.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${request.userName}</p>
                    <p><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> ${request.department}</p>
                    <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:</strong> ${request.paperTypeName}</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${request.quantity}</p>
                </div>
                <div>
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠:</strong> ${new Date(request.requestDate).toLocaleDateString('th-TH')}</p>
                    <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${request.note || '-'}</p>
                    <div class="mt-3 space-x-2">
                        <button onclick="approveRequest('${request.id}')" class="btn-success text-white px-4 py-2 rounded hover:opacity-90">
                            ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </button>
                        <button onclick="rejectRequest('${request.id}')" class="btn-danger text-white px-4 py-2 rounded hover:opacity-90">
                            ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </button>
                    </div>
                </div>
            </div>
        `;
                container.appendChild(requestDiv);
            });
        }


        function approveRequest(requestId) {
            console.log('[DEBUG] Approve click! requestId=', requestId);
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    const request = usageRequests.find(req => String(req.id) === String(requestId));
                    if (request) {
                        request.status = 'Approved';
                        request.approvedBy = currentUser;
                        request.approvedDate = new Date().toISOString();

                        saveToLocalStorage();

                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡∏±‡∏ö Google Sheets
                        sendToGoogleSheet({
                            action: 'updateApproval',
                            requestId: requestId,
                            status: 'Approved',
                            approvedBy: currentUser,
                            approvedDate: request.approvedDate
                        }, function (response) {
                            if (response && response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                    text: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                                }).then(() => {
                                    loadUsageRequestsFromSheet(function () {
                                        loadPendingRequests();
                                        loadApprovedRequests();
                                        updateDashboard();
                                    });
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets ‡πÑ‡∏î‡πâ'
                                });
                            }
                        });
                    }
                }
            });
        }


        function rejectRequest(requestId) {
            Swal.fire({
                title: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                input: 'textarea',
                inputPlaceholder: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•...',
                showCancelButton: true,
                confirmButtonText: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => {
                    if (!value) {
                        return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const request = usageRequests.find(req => req.id === requestId);
                    if (request) {
                        request.status = 'Rejected';
                        request.rejectedBy = currentUser;
                        request.rejectedDate = new Date().toISOString();
                        request.rejectionReason = result.value;

                        saveToLocalStorage();
                        loadPendingRequests();

                        Swal.fire({
                            icon: 'success',
                            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                            text: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                        });
                    }
                }
            });
        }

        // Report functions
        function loadReportData() {
            const statusFilter = document.getElementById('statusFilter').value;
            const container = document.getElementById('reportData');

            let filteredRequests = usageRequests;
            if (statusFilter !== 'All') {
                filteredRequests = usageRequests.filter(req => req.status === statusFilter);
            }

            // Create table
            let tableHTML = `
            <table class="min-w-full bg-white border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 border-b text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
                        <th class="px-4 py-2 border-b text-left">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th>
                        <th class="px-4 py-2 border-b text-left">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                        <th class="px-4 py-2 border-b text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</th>
                        <th class="px-4 py-2 border-b text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="px-4 py-2 border-b text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                        <th class="px-4 py-2 border-b text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å</th>
                        <th class="px-4 py-2 border-b text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</th>
                    </tr>
                </thead>
                <tbody>
        `;

            filteredRequests.forEach(request => {
                const statusClass = request.status === 'Approved' ? 'text-green-600' :
                    request.status === 'Rejected' ? 'text-red-600' : 'text-yellow-600';

                const withdrawnClass = request.withdrawnStatus === 'Withdrawn' ? 'text-green-600' : 'text-gray-400';
                const withdrawnText = request.withdrawnStatus === 'Withdrawn' ? '‚úÖ ‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '-';
                const withdrawnDate = request.withdrawnDate ? new Date(request.withdrawnDate).toLocaleDateString('th-TH') : '-';

                tableHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 border-b">${new Date(request.requestDate).toLocaleDateString('th-TH')}</td>
                    <td class="px-4 py-2 border-b">${request.userName}</td>
                    <td class="px-4 py-2 border-b">${request.department}</td>
                    <td class="px-4 py-2 border-b">${request.paperTypeName}</td>
                    <td class="px-4 py-2 border-b">${request.quantity}</td>
                    <td class="px-4 py-2 border-b ${statusClass}">${request.status}</td>
                    <td class="px-4 py-2 border-b ${withdrawnClass}">${withdrawnText}</td>
                    <td class="px-4 py-2 border-b">${withdrawnDate}</td>
                </tr>
            `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;

            // Update chart
            updateReportChart(filteredRequests);
        }

        function updateReportChart(requests) {
            const ctx = document.getElementById('reportChart').getContext('2d');
            // FIX: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error destroy is not a function
            if (window.reportChart && typeof window.reportChart.destroy === "function") {
                window.reportChart.destroy();
            }

            const paperTypeData = {};
            requests.forEach(request => {
                if (request.withdrawnStatus === 'Withdrawn') {
                    if (!paperTypeData[request.paperTypeName]) {
                        paperTypeData[request.paperTypeName] = 0;
                    }
                    paperTypeData[request.paperTypeName] += request.quantity;
                }
            });

            window.reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(paperTypeData),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏£‡∏¥‡∏á',
                        data: Object.values(paperTypeData),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // FIXED
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // Report functions


        function loadUsageRequestsFromSheet(callback) {
            loadFromGoogleSheet('UsageRequests', function (response) {
                if (response && response.data) {
                    usageRequests = response.data.map(item => ({
                        id: item.ID,
                        userId: item.UserID,             // U ‡πÉ‡∏´‡∏ç‡πà I ‡πÉ‡∏´‡∏ç‡πà D ‡πÉ‡∏´‡∏ç‡πà (OK)
                        userName: item.UserName,         // U ‡πÉ‡∏´‡∏ç‡πà N ‡πÉ‡∏´‡∏ç‡πà (OK)
                        department: item.Department,
                        paperTypeId: item.PaperTypeID,
                        paperTypeName: item.PaperTypeName,
                        quantity: parseInt(item.Quantity || 0),
                        note: item.Note,
                        status: (item.Status || '').trim(), // ‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô toLowerCase ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ! ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏£‡∏á‡πÜ‡∏Å‡πà‡∏≠‡∏ô
                        requestDate: item.RequestDate,
                        requestedBy: item.RequestedBy,
                        approvedBy: item.ApprovedBy,
                        approvedDate: item.ApprovedDate,
                        rejectedBy: item.RejectedBy,
                        rejectedDate: item.RejectedDate,
                        rejectionReason: item.RejectionReason,
                        withdrawnStatus: item.WithdrawnStatus,
                        withdrawnDate: item.WithdrawnDate,
                        withdrawnBy: item.WithdrawnBy,
                    }));



                    console.log("Usage raw data from GoogleSheet", response.data[0]);// <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    saveToLocalStorage();
                    if (callback) callback();
                }
            });
        }


        function updateDashboard() {
            // ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            const pending = usageRequests.filter(req => req.status === 'Pending').length;
            document.getElementById('pendingRequests').textContent = pending;

            // ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const today = new Date().toISOString().slice(0, 10); // 'YYYY-MM-DD'
            const todayUsage = usageRequests.filter(
                req => req.withdrawnStatus === 'Withdrawn' && req.withdrawnDate && req.withdrawnDate.startsWith(today)
            ).reduce((sum, req) => sum + (parseInt(req.quantity) || 0), 0);
            document.getElementById('todayUsage').textContent = todayUsage;

            // ==== ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å Google Sheet PaperStock ‡∏™‡∏î‡πÜ ====
            loadFromGoogleSheet('PaperStock', function (res) {
                let totalStock = 0;
                if (res.success && res.data) {
                    res.data.forEach(row => {
                        totalStock += Number(row.Quantity || 0);
                    });
                }
                document.getElementById('remainingPaper').textContent = totalStock;
                console.log('todayUsage =', todayUsage, ', totalStock =', totalStock, ', pending =', pending);
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏Å‡∏£‡∏≤‡∏ü
            updateDashboardChart();
            showDashboardNews();

        }

        // Report functions
        function updateDashboardChart() {
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° ctx ‡∏Ç‡∏≠‡∏á Dashboard
            const ctx = document.getElementById('paperTypeChart').getContext('2d');
            if (window.dashboardChart && typeof window.dashboardChart.destroy === "function") {
                window.dashboardChart.destroy();
            }

            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Withdrawn ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            const paperTypeData = {};
            usageRequests.forEach(request => {
                // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏•‡∏∑‡∏≠‡∏Å filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß (Withdrawn) ‡∏´‡∏£‡∏∑‡∏≠ Approved+Withdrawn
                if (request.withdrawnStatus === 'Withdrawn') {
                    if (!paperTypeData[request.paperTypeName]) {
                        paperTypeData[request.paperTypeName] = 0;
                    }
                    paperTypeData[request.paperTypeName] += request.quantity;
                }
            });

            window.dashboardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(paperTypeData),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏£‡∏¥‡∏á (Dashboard)',
                        data: Object.values(paperTypeData),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß
        function submitNewsForm(event) {
            event.preventDefault();
            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('newsContent').value.trim();

            if (!title || !content) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á'
                });
                return;
            }
            addNews(title, content);
        }

        function addNews(title, content) {
            const callback = 'cb_' + Math.random().toString(36).substring(2);
            window[callback] = function (res) {
                delete window[callback];
                if (res.success) {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    document.getElementById('newsTitle').value = '';
                    document.getElementById('newsContent').value = '';
                    loadNews(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà
                } else {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
            };
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=addNews'
                + '&title=' + encodeURIComponent(title)
                + '&content=' + encodeURIComponent(content)
                + '&callback=' + callback;
            document.body.appendChild(script);
        }

        function loadNews() {
            const callback = 'cb_' + Math.random().toString(36).substring(2);
            window[callback] = function (res) {
                delete window[callback];
                const newsListDiv = document.getElementById('newsList');
                newsListDiv.innerHTML = '';
                if (res.success && res.data && res.data.length > 0) {
                    res.data.reverse().forEach(item => {
                        newsListDiv.innerHTML += `<div class="border-b py-2">
                <div class="font-semibold">${item.title}</div>
                <div class="text-xs text-gray-600">${new Date(item.date).toLocaleString('th-TH')}</div>
                <div>${item.content}</div>
            </div>`;
                    });
                } else {
                    newsListDiv.innerHTML = '<div class="text-gray-400 py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß</div>';
                }
            };
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=getNews&callback=' + callback;
            document.body.appendChild(script);
        }



        // ‡∏≠‡πà‡∏≤‡∏ô stock

        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ stockMap = { "1234": 50, "5678": 90 }
        function loadCurrentStock() {
            loadFromGoogleSheet('PaperStock', function (res) {
                const stockDiv = document.getElementById('currentStockList');
                stockDiv.innerHTML = '';
                let stockMap = {};
                if (res.success && res.data) {
                    res.data.forEach(row => {
                        // ‡πÉ‡∏ä‡πâ PaperTypeId ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                        stockMap[String(row.PaperTypeId)] = Number(row.Quantity || 0);
                    });
                }

                if (!paperTypes || paperTypes.length === 0) {
                    stockDiv.innerHTML = '<div class="text-gray-400 py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</div>';
                    return;
                }

                // Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ stock
                paperTypes.forEach(pt => {
                    const qty = stockMap[String(pt.id)] !== undefined ? stockMap[String(pt.id)] : 0;
                    stockDiv.innerHTML += `
                <div class="flex justify-between border-b py-2">
                    <div>${pt.name}</div>
                    <div class="font-bold text-blue-700">${qty}</div>
                </div>
            `;
                });
            });
        }




        // ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stock
        function addOrUpdateStock(paperTypeId, qty) {
            const callback = 'cb_' + Math.random().toString(36).substring(2);
            window[callback] = function (res) {
                // res.success
                console.log(res);
                delete window[callback];
            };
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=addOrUpdatePaperStock'
                + '&paperTypeId=' + encodeURIComponent(paperTypeId)
                + '&quantity=' + encodeURIComponent(qty)
                + '&callback=' + callback;
            document.body.appendChild(script);
        }
        function loadCurrentStockList() {
            const container = document.getElementById('currentStockList');
            if (!container) return;

            // ‡πÇ‡∏´‡∏•‡∏î paperTypes ‡∏Å‡∏±‡∏ö stock
            let stock = {};
            if (localStorage.getItem('paperStock')) {
                stock = JSON.parse(localStorage.getItem('paperStock'));
            }
            // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥ paperTypes ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á sync ‡∏Å‡∏±‡∏ö Google Sheet ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á)

            // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            let html = '<table class="min-w-full text-left"><thead><tr><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead><tbody>';
            paperTypes.forEach(type => {
                html += `<tr>
            <td>${type.name}</td>
            <td>${stock[type.id] || 0}</td>
        </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }


        function showDashboardNews() {
            const callback = 'cb_' + Math.random().toString(36).substring(2);
            window[callback] = function (res) {
                delete window[callback];
                const dashboardNewsDiv = document.getElementById('dashboardNews');
                if (!dashboardNewsDiv) return;

                dashboardNewsDiv.innerHTML = '';
                if (res.success && res.data && res.data.length > 0) {
                    // ‡πÄ‡∏≠‡∏≤ 2 ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    res.data.slice(-2).reverse().forEach(item => {
                        dashboardNewsDiv.innerHTML += `
                    <div class="bg-blue-50 p-3 rounded-lg mb-2">
                        <p class="text-sm text-blue-800">üì¢ ${item.title}</p>
                        <div class="text-xs text-gray-600">${new Date(item.date).toLocaleString('th-TH')}</div>
                    </div>`;
                    });
                }
            };
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=getNews&callback=' + callback;
            document.body.appendChild(script);
        }

        function addPaperStock(event) {
            event.preventDefault();

            const paperTypeId = document.getElementById('stockPaperType').value;
            const qty = document.getElementById('stockChangeAmount').value;

            if (!paperTypeId || !qty) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
                return;
            }

            const callback = 'cb_' + Math.random().toString(36).substring(2);
            window[callback] = function (res) {
                delete window[callback];
                if (res.success) {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    document.getElementById('stockChangeAmount').value = "";
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
                    loadCurrentStock();
                } else {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ', 'error');
                }
            };

            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL
                + '?action=addOrUpdatePaperStock'
                + '&paperTypeId=' + encodeURIComponent(paperTypeId)
                + '&quantity=' + encodeURIComponent(qty)
                + '&callback=' + callback;
            document.body.appendChild(script);

        }
        console.log('paperTypes', paperTypes);

        function loadPaperTypesFromSheet(callback) {
            loadFromGoogleSheet('PaperTypes', function (res) {
                if (res.success && res.data) {
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet (‡∏ä‡∏∑‡πà‡∏≠ key ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á)
                    paperTypes = res.data.map(row => ({
                        id: row.ID,
                        name: row.Name,
                        description: row.Description,
                        createdAt: row.CreatedAt
                    }));
                    saveToLocalStorage();
                    if (callback) callback();   // render ‡∏´‡∏£‡∏∑‡∏≠ callback ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                }
            });
        }
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ manageStockPage
        function openManageStockPage() {
            // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (async)
            loadPaperTypesFromSheet(function () {
                // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡πà‡∏≠‡∏¢ render dropdown + ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                renderStockDropdown();
                loadCurrentStock();
            });
        }

        function renderStockDropdown() {
            const select = document.getElementById('stockPaperType');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© --</option>';
            paperTypes.forEach(pt => {
                select.innerHTML += `<option value="${pt.id}">${pt.name}</option>`;
            });
        }
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // KEEP ONLY THIS VERSION (with password hash)
        async function addUser(event) {
            event.preventDefault();
            const name = document.getElementById('userName').value;
            const department = document.getElementById('userDepartment').value;
            const role = document.getElementById('userRole').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;

            const passwordHash = await hashPassword(password);

            const newUser = {
                id: Date.now(),
                name,
                department,
                role,
                username,
                passwordHash,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            saveToLocalStorage();

            // Send to Google Sheet
            const data = {
                action: 'addUser',
                name,
                department,
                role,
                username,
                passwordHash,
                createdAt: newUser.createdAt
            };

            sendToGoogleSheet(data, function (response) {
                if (response && response.success) {
                    Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
                }
            });
        }
        function loadDataFast(sheet, key, updateUI) {
            // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å cache ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (UI ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
            const cached = localStorage.getItem(key);
            if (cached) updateUI(JSON.parse(cached));

            // fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î‡∏à‡∏≤‡∏Å Google Sheet (background)
            loadFromGoogleSheet(sheet, function (res) {
                if (res && res.data) {
                    localStorage.setItem(key, JSON.stringify(res.data));
                    updateUI(res.data); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
                }
            });
        }


        function saveCache(key, data) {
            localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data }));
        }
        function loadCache(key, maxAge = 30000) {
            const item = localStorage.getItem(key);
            if (!item) return null;
            const { ts, data } = JSON.parse(item);
            if (Date.now() - ts > maxAge) return null;
            return data;
        }

        function autofillUserInfo() {
            const user = users.find(u => u.username === currentUser);
            if (user) {
                document.getElementById('requestUserName').value = user.name;
                document.getElementById('requestDepartment').value = user.department;
            }
        }






        // ---- END ----
    </script>
</body>

</html>